@model TechShop.Models.Product
@{
    ViewBag.Title = Model.ProductName;
}

<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Trang chủ</a></li>
        <li class="breadcrumb-item"><a href="@Url.Action("Products", "Home")">Sản phẩm</a></li>
        <li class="breadcrumb-item"><a href="@Url.Action("Products", "Home", new { categoryId = Model.CategoryID })">@Model.Category.CategoryName</a></li>
        <li class="breadcrumb-item active">@Model.ProductName</li>
    </ol>
</nav>

<!-- Product Detail -->
<div class="row">
    <div class="col-md-5">
        <div class="card">
            <img src="@Model.PrimaryImageUrl"
                 class="card-img-top"
                 alt="@Model.ProductName"
                 style="width: 100%; height: auto;">
        </div>

        @if (Model.ProductImages != null && Model.ProductImages.Any())
        {
            <div class="row mt-3">
                @foreach (var image in Model.ProductImages.OrderBy(i => i.DisplayOrder).Take(4))
                {
                    <div class="col-3">
                        <img src="@image.ImageURL" class="img-thumbnail" alt="@Model.ProductName" style="cursor: pointer;">
                    </div>
                }
            </div>
        }
    </div>

    <div class="col-md-7">
        <h2 class="mb-3">@Model.ProductName</h2>

        <div class="mb-3">
            <span class="badge badge-info">@Model.Category.CategoryName</span>
            <span class="badge badge-secondary">@Model.Brand.BrandName</span>
            @if (Model.StockQuantity > 0)
            {
                <span class="badge badge-success">Còn hàng</span>
            }
            else
            {
                <span class="badge badge-secondary">Hết hàng</span>
            }
            @if (Model.IsFeatured)
            {
                <span class="badge badge-warning">Nổi bật</span>
            }
        </div>

        <div class="mb-4">
            @if (Model.HasDiscount)
            {
                <h3 class="text-danger mb-1">@Model.DisplayPrice.ToString("N0") đ</h3>
                <p class="text-muted"><del>@Model.Price.ToString("N0") đ</del> <span class="badge badge-danger">-@Model.DiscountPercentage%</span></p>
            }
            else
            {
                <h3 class="text-danger">@Model.Price.ToString("N0") đ</h3>
            }
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Thông tin sản phẩm</h5>
                <table class="table table-sm">
                    <tr>
                        <th width="30%">Mã sản phẩm:</th>
                        <td>@(Model.SKU ?? "SP" + Model.ProductID.ToString("D6"))</td>
                    </tr>
                    <tr>
                        <th>Thương hiệu:</th>
                        <td>@Model.Brand.BrandName</td>
                    </tr>
                    <tr>
                        <th>Danh mục:</th>
                        <td>@Model.Category.CategoryName</td>
                    </tr>
                    @if (Model.Weight.HasValue)
                    {
                        <tr>
                            <th>Trọng lượng:</th>
                            <td>@Model.Weight.Value kg</td>
                        </tr>
                    }
                    <tr>
                        <th>Bảo hành:</th>
                        <td>@Model.Warranty tháng</td>
                    </tr>
                    <tr>
                        <th>Tình trạng:</th>
                        <td>
                            @if (Model.StockQuantity > 0)
                            {
                                <span class="text-success">Còn @Model.StockQuantity sản phẩm</span>
                            }
                            else
                            {
                                <span class="text-danger">Hết hàng</span>
                            }
                        </td>
                    </tr>
                </table>
            </div>
        </div>

        @if (Model.StockQuantity > 0)
        {
            <div class="form-group">
                <label for="quantity">Số lượng:</label>
                <div class="input-group" style="max-width: 200px;">
                    <div class="input-group-prepend">
                        <button class="btn btn-outline-secondary" type="button" onclick="decreaseQuantity()">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                    <input type="number" class="form-control text-center" id="quantity" value="1" min="1" max="@Model.StockQuantity">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary" type="button" onclick="increaseQuantity()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="btn-group mb-3">
                <button class="btn btn-primary btn-lg" onclick="addToCartWithQuantity()">
                    <i class="fas fa-cart-plus"></i> Thêm vào giỏ hàng
                </button>
                <a href="@Url.Action("Index", "Cart")" class="btn btn-success btn-lg">
                    <i class="fas fa-shopping-cart"></i> Xem giỏ hàng
                </a>
            </div>
        }
        else
        {
            <button class="btn btn-secondary btn-lg" disabled>
                <i class="fas fa-ban"></i> Hết hàng
            </button>
        }

        <div class="mt-4">
            <h5>Mô tả sản phẩm</h5>
            <p>@Html.Raw(Model.Description?.Replace("\n", "<br>"))</p>
        </div>

        @if (!string.IsNullOrEmpty(Model.Specifications))
        {
            <div class="mt-4">

                <!-- TIÊU ĐỀ -->
                <h5 class="section-title">
                    <i class="fas fa-microchip"></i> Thông số kỹ thuật
                </h5>

                <!-- CARD THÔNG SỐ -->
                <div class="tech-spec-card">
                    <div class="tech-spec-content">
                        @Html.Raw(Model.Specifications?.Replace("\n", "<br>"))
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- Related Products -->
@if (ViewBag.RelatedProducts != null && ((IEnumerable<TechShop.Models.Product>)ViewBag.RelatedProducts).Any())
{
    <hr class="my-5">
    <h4 class="mb-4">Sản phẩm liên quan</h4>
    <div class="row">
        @foreach (var product in (IEnumerable<TechShop.Models.Product>)ViewBag.RelatedProducts)
        {
            <div class="col-md-3 col-sm-6 mb-4">
                <div class="card h-100 product-card">
                    <a href="@Url.Action("ProductDetail", "Home", new { id = product.ProductID })">
                        <img src="@product.PrimaryImageUrl"
                             class="card-img-top"
                             alt="@product.ProductName"
                             style="height: 200px; object-fit: cover;">
                    </a>
                    <div class="card-body">
                        <h5 class="card-title">
                            <a href="@Url.Action("ProductDetail", "Home", new { id = product.ProductID })" class="text-dark text-decoration-none">
                                @product.ProductName
                            </a>
                        </h5>
                        @if (product.HasDiscount)
                        {
                            <h5 class="text-danger mb-0">@product.DisplayPrice.ToString("N0") đ</h5>
                            <small class="text-muted"><del>@product.Price.ToString("N0") đ</del></small>
                        }
                        else
                        {
                            <h5 class="text-danger">@product.Price.ToString("N0") đ</h5>
                        }
                    </div>
                    <div class="card-footer bg-white border-0">
                        @if (product.StockQuantity > 0)
                        {
                            <button class="btn btn-primary btn-block btn-sm" onclick="addToCart(@product.ProductID)">
                                <i class="fas fa-cart-plus"></i> Thêm vào giỏ
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-secondary btn-block btn-sm" disabled>
                                Hết hàng
                            </button>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}

@section scripts {
    <script>
    function increaseQuantity() {
        var input = document.getElementById('quantity');
        var max = parseInt(input.max);
        var current = parseInt(input.value);
        if (current < max) {
            input.value = current + 1;
        }
    }

    function decreaseQuantity() {
        var input = document.getElementById('quantity');
        var current = parseInt(input.value);
        if (current > 1) {
            input.value = current - 1;
        }
    }

    function addToCartWithQuantity() {
        var quantity = parseInt(document.getElementById('quantity').value);
        addToCart(@Model.ProductID, quantity);
    }
    </script>

    <style>
        .product-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }

            .product-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            }


        <style >
        /* --- Tiêu đề Thông số kỹ thuật --- */
        .section-title {
            font-weight: 700;
            font-size: 22px;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: #007bff;
            font-size: 22px;
        }

        /* --- Khung CARD chính --- */
        .tech-spec-card {
            background: #f8f9fc;
            border: 1px solid #e2e6ea;
            border-radius: 12px;
            padding: 20px 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: 0.3s ease;
            margin-bottom: 25px;
        }

            .tech-spec-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            }

        /* --- Nội dung text --- */
        .tech-spec-content {
            font-size: 15px;
            line-height: 1.7;
            color: #444;
            white-space: normal;
        }

            .tech-spec-content br {
                margin-bottom: 6px;
            }
    </style>

    </style>
}